<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Horizon House ‚Äî Member Application</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Horizon House Sober Living Member Application">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root { --slate:#2b3440; --amber:#c98a22; --sand:#f5f1ea; }
    body { margin:0; font-family:Nunito,system-ui; background:var(--sand); color:var(--slate); }
    header { background:var(--slate); color:#fff; padding:1rem 0; }
    .wrap { max-width:900px; margin:0 auto; padding:1rem; }
    h1, h2 { font-family:Inter; }
    form { display:grid; gap:1rem; background:#fff; padding:1.5rem; border-radius:.5rem; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    label { font-weight:600; }
    input, textarea, select { padding:.6rem; border:1px solid #ccc; border-radius:.4rem; font-size:1rem; width:100%; }
    .inline { display:flex; gap:1rem; }
    .checkbox-group { display:flex; align-items:center; gap:.2rem; }
    @media (max-width: 640px) {
  .inline {
    flex-direction: column;   /* stack YES and NO vertically */
    align-items: flex-start;
  }
  .checkbox-group {
    gap: .1rem;
  }
}
    .section-title { margin-top:1.5rem; font-size:1.3rem; font-family:Inter; }
    button { background:var(--amber); border:none; padding:.8rem 1.2rem; border-radius:.4rem; font-weight:700; cursor:pointer; }
    footer { text-align:center; padding:2rem 0; color:#555; font-size:.9rem; }
    
    .conditional-field {
      display: none;
      padding-left: 1rem;
      border-left: 3px solid #667eea;
      margin-top: 0.5rem;
      animation: slideDown 0.3s ease;
    }
    
    .signature-options {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .sig-option-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #ccc;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .sig-option-btn.active {
      border-color: #667eea;
      background: #eef2ff;
      color: #667eea;
    }
    
    .sig-option-btn:hover {
      border-color: #667eea;
    }
    
    .signature-area {
      display: none;
      margin-top: 15px;
    }
    
    .signature-area.active {
      display: block;
    }
    
    .signature-canvas {
      border: 2px solid #ccc;
      border-radius: 8px;
      cursor: crosshair;
      background: white;
      width: 100%;
      height: 200px;
      touch-action: none;
    }
    
    .sig-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .sig-controls button {
      padding: 8px 16px;
      background: #666;
      font-size: 14px;
    }
    
    .typed-signature {
      font-family: 'Brush Script MT', cursive;
      font-size: 32px;
      padding: 20px;
      border: 2px solid #ccc;
      border-radius: 8px;
      text-align: center;
      background: white;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @media print {
      body {
        background: white;
      }
      
      .conditional-field {
        display: block !important;
        opacity: 1 !important;
        transform: none !important;
      }
      
      button {
        display: none;
      }
      
      .reminder-box {
        display: none;
      }
      
      .date-display {
        display: none;
      }
      
      input[type="date"] {
        position: relative;
      }
      
      input[type="date"]::after {
        content: attr(data-formatted);
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        padding: 0.6rem;
        background: white;
      }
    }
    
    #successModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .success-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 3rem;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      text-align: center;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .success-box h2 {
      margin-top: 0;
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    
    .success-box p {
      font-size: 1.1rem;
      line-height: 1.8;
      margin-bottom: 1.5rem;
    }
    
    .success-box .contact-info {
      background: rgba(255, 255, 255, 0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1.5rem;
    }

    /* Reference Modal */
    .reference-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f7fafc;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .reference-content {
      background: white;
      padding: 40px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .reference-content h2 {
      margin-top: 0;
      color: #2d3748;
      font-size: 24px;
    }

    .reference-content p {
      color: #4a5568;
      line-height: 1.6;
    }

    .reference-input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #cbd5e0;
      border-radius: 8px;
      margin: 15px 0;
      font-family: monospace;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .reference-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .ref-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }

    .ref-btn-primary {
      background: #667eea;
      color: white;
    }

    .ref-btn-primary:hover {
      background: #5568d3;
    }

    .ref-btn-secondary {
      background: #e2e8f0;
      color: #2d3748;
    }

    .ref-btn-secondary:hover {
      background: #cbd5e0;
    }
  </style>
</head>

<body>

<!-- Reference Number Modal -->
<div id="referenceModal" class="reference-modal">
  <div class="reference-content">
    <h2>üìù Application Draft</h2>
    <p>Do you have a reference number from a previously saved draft?</p>
    
    <input type="text" id="referenceInput" class="reference-input" placeholder="Enter Reference Number" maxlength="6">
    
    <div class="reference-buttons">
      <button type="button" class="ref-btn ref-btn-secondary" onclick="startNewApplication()">‚ú® Start New Application</button>
      <button type="button" class="ref-btn ref-btn-primary" onclick="loadDraft()">üìÇ Load Draft</button>
    </div>
    
    <p style="font-size: 14px; color: #718096; margin-top: 20px; text-align: center;">
      <em>Your draft will auto-save as you complete the form</em>
    </p>
  </div>
</div>

<header id="mainHeader" style="display: none;">
  <div class="wrap">
    <h1>Horizon House Sober Living ‚Äî Member Application</h1>
  </div>
</header>

<main class="wrap" id="mainContent" style="display: none;">

  <div id="referenceDisplay" style="display:none; background: #f7fafc; padding: 15px; border-radius: 8px; border: 2px solid #4299e1; margin-bottom: 20px; text-align: center;">
    <p style="margin: 0; color: #2d3748; font-weight: 600;">
      üîë Your Reference Number: <strong id="refNumberText" style="font-family: monospace; letter-spacing: 3px; font-size: 18px; color: #2b6cb0;"></strong>
      <button type="button" onclick="saveDraft()" style="margin-left: 15px; padding: 6px 12px; background: #4299e1; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">üíæ Save Now</button>
    </p>
    <p style="margin: 5px 0 0 0; font-size: 13px; color: #718096;">
      Save this number to resume your application later
    </p>
    <p id="saveIndicator" style="margin: 8px 0 0 0; font-size: 12px; color: #48bb78; font-weight: 600; display: none;">
      ‚úì Draft saved
    </p>
  </div>

  <div id="savingStatus" style="display:none; padding: 10px; margin-bottom: 15px; border-radius: 4px; text-align: center;">
    <span id="savingMessage">Draft saved</span>
  </div>

  <!-- FORM WITH BACKEND SUBMISSION -->
  <form id="applicationForm">

    <div style="background-color: #e8f4f8; padding: 15px; border-left: 4px solid #0066cc; margin-bottom: 20px; border-radius: 4px;">
      <strong>üìã Please Be Honest</strong>
      <p style="margin: 8px 0 0 0; line-height: 1.5;">Your answers help us determine the best path for your successful recovery. This information is used to support you, not to disqualify your acceptance. Honesty allows us to provide the most appropriate care and environment for your journey.</p>
    </div>

    <h2 class="section-title">Personal Information</h2>

    <div class="inline">
      <div style="flex:1">
        <label>First Name</label>
        <input type="text" name="first_name" required>
      </div>
      <div style="flex:1">
        <label>Last Name</label>
        <input type="text" name="last_name" required>
      </div>
    </div>

    <label>Address</label>
    <input type="text" name="address">

    <div class="inline">
      <div style="flex:2">
        <label>City</label>
        <input type="text" name="city">
      </div>
      <div style="flex:0.6">
        <label>State</label>
        <select name="state" id="address_state">
          <option value="">ST</option>
          <option value="AL">AL</option>
          <option value="AK">AK</option>
          <option value="AZ">AZ</option>
          <option value="AR">AR</option>
          <option value="CA">CA</option>
          <option value="CO">CO</option>
          <option value="CT">CT</option>
          <option value="DE">DE</option>
          <option value="FL">FL</option>
          <option value="GA">GA</option>
          <option value="HI">HI</option>
          <option value="ID">ID</option>
          <option value="IL">IL</option>
          <option value="IN">IN</option>
          <option value="IA">IA</option>
          <option value="KS">KS</option>
          <option value="KY">KY</option>
          <option value="LA">LA</option>
          <option value="ME">ME</option>
          <option value="MD">MD</option>
          <option value="MA">MA</option>
          <option value="MI">MI</option>
          <option value="MN">MN</option>
          <option value="MS">MS</option>
          <option value="MO">MO</option>
          <option value="MT">MT</option>
          <option value="NE">NE</option>
          <option value="NV">NV</option>
          <option value="NH">NH</option>
          <option value="NJ">NJ</option>
          <option value="NM">NM</option>
          <option value="NY">NY</option>
          <option value="NC">NC</option>
          <option value="ND">ND</option>
          <option value="OH">OH</option>
          <option value="OK">OK</option>
          <option value="OR">OR</option>
          <option value="PA">PA</option>
          <option value="RI">RI</option>
          <option value="SC">SC</option>
          <option value="SD">SD</option>
          <option value="TN">TN</option>
          <option value="TX">TX</option>
          <option value="UT">UT</option>
          <option value="VT">VT</option>
          <option value="VA">VA</option>
          <option value="WA">WA</option>
          <option value="WV">WV</option>
          <option value="WI">WI</option>
          <option value="WY">WY</option>
          <option value="DC">DC</option>
        </select>
      </div>
      <div style="flex:1">
        <label>ZIP</label>
        <input type="text" name="zip">
      </div>
    </div>

    <label>Gender</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="gender" value="male"> Male</label>
      <label class="checkbox-group"><input type="radio" name="gender" value="female"> Female</label>
      <label class="checkbox-group"><input type="radio" name="gender" value="other"> Other</label>
    </div>

    <label>Date of Birth</label>
    <input type="date" name="dob">

    <div class="inline">
      <div style="flex: 2;">
        <label>Driver's License Number</label>
        <input type="text" name="dl_number">
      </div>
      <div style="flex: 1;">
        <label>State</label>
        <select name="dl_state" id="dl_state">
          <option value="">Select State</option>
          <option value="AL">AL</option>
          <option value="AK">AK</option>
          <option value="AZ">AZ</option>
          <option value="AR">AR</option>
          <option value="CA">CA</option>
          <option value="CO">CO</option>
          <option value="CT">CT</option>
          <option value="DE">DE</option>
          <option value="FL">FL</option>
          <option value="GA">GA</option>
          <option value="HI">HI</option>
          <option value="ID">ID</option>
          <option value="IL">IL</option>
          <option value="IN">IN</option>
          <option value="IA">IA</option>
          <option value="KS">KS</option>
          <option value="KY">KY</option>
          <option value="LA">LA</option>
          <option value="ME">ME</option>
          <option value="MD">MD</option>
          <option value="MA">MA</option>
          <option value="MI">MI</option>
          <option value="MN">MN</option>
          <option value="MS">MS</option>
          <option value="MO">MO</option>
          <option value="MT">MT</option>
          <option value="NE">NE</option>
          <option value="NV">NV</option>
          <option value="NH">NH</option>
          <option value="NJ">NJ</option>
          <option value="NM">NM</option>
          <option value="NY">NY</option>
          <option value="NC">NC</option>
          <option value="ND">ND</option>
          <option value="OH">OH</option>
          <option value="OK">OK</option>
          <option value="OR">OR</option>
          <option value="PA">PA</option>
          <option value="RI">RI</option>
          <option value="SC">SC</option>
          <option value="SD">SD</option>
          <option value="TN">TN</option>
          <option value="TX">TX</option>
          <option value="UT">UT</option>
          <option value="VT">VT</option>
          <option value="VA">VA</option>
          <option value="WA">WA</option>
          <option value="WV">WV</option>
          <option value="WI">WI</option>
          <option value="WY">WY</option>
          <option value="DC">DC</option>
        </select>
      </div>
      <div style="flex: 1; position: relative;">
        <label>DL Expiration Date</label>
        <input type="text" name="dl_expiration" id="dl_expiration" readonly style="background: #f0f0f0; cursor: pointer;" placeholder="Click to select">
        <select name="dl_exp_year" id="dl_exp_year" style="position: absolute; top: 100%; left: 0; right: 0; margin-top: 5px; display: none; z-index: 10;">
          <option value="">Select Year</option>
        </select>
      </div>
    </div>

    <label>Do you have a vehicle?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="has_vehicle" value="yes" id="vehicle_yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="has_vehicle" value="no" id="vehicle_no"> No</label>
    </div>

    <div id="vehicle_details" class="conditional-field">
      <div class="inline">
        <div style="flex: 2;">
          <label>Vehicle Make & Model</label>
          <input type="text" name="vehicle">
        </div>
        <div style="flex: 1;">
          <label>License Plate No</label>
          <input type="text" name="license_plate" placeholder="e.g., ABC123">
        </div>
        <div style="flex: 1;">
          <label>Plate State</label>
          <select name="plate_state" id="plate_state">
            <option value="">State</option>
            <option value="AL">AL</option>
            <option value="AK">AK</option>
            <option value="AZ">AZ</option>
            <option value="AR">AR</option>
            <option value="CA">CA</option>
            <option value="CO">CO</option>
            <option value="CT">CT</option>
            <option value="DE">DE</option>
            <option value="FL">FL</option>
            <option value="GA">GA</option>
            <option value="HI">HI</option>
            <option value="ID">ID</option>
            <option value="IL">IL</option>
            <option value="IN">IN</option>
            <option value="IA">IA</option>
            <option value="KS">KS</option>
            <option value="KY">KY</option>
            <option value="LA">LA</option>
            <option value="ME">ME</option>
            <option value="MD">MD</option>
            <option value="MA">MA</option>
            <option value="MI">MI</option>
            <option value="MN">MN</option>
            <option value="MS">MS</option>
            <option value="MO">MO</option>
            <option value="MT">MT</option>
            <option value="NE">NE</option>
            <option value="NV">NV</option>
            <option value="NH">NH</option>
            <option value="NJ">NJ</option>
            <option value="NM">NM</option>
            <option value="NY">NY</option>
            <option value="NC">NC</option>
            <option value="ND">ND</option>
            <option value="OH">OH</option>
            <option value="OK">OK</option>
            <option value="OR">OR</option>
            <option value="PA">PA</option>
            <option value="RI">RI</option>
            <option value="SC">SC</option>
            <option value="SD">SD</option>
            <option value="TN">TN</option>
            <option value="TX">TX</option>
            <option value="UT">UT</option>
            <option value="VT">VT</option>
            <option value="VA">VA</option>
            <option value="WA">WA</option>
            <option value="WV">WV</option>
            <option value="WI">WI</option>
            <option value="WY">WY</option>
            <option value="DC">DC</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label>Registration Expires</label>
          <input type="date" name="registration_expires">
        </div>
      </div>
    </div>

    <label>Cell Phone</label>
    <input type="tel" name="phone">

    <label>Email</label>
    <input type="email" name="email">

    <label>Desired Move‚ÄëIn Date</label>
    <input type="date" name="move_in">

    <label>Why are you seeking sober living at this time?</label>
    <textarea name="seeking_reason" rows="3" placeholder="Please share your reason for seeking sober living support..."></textarea>

    <label>Referred By</label>
    <input type="text" name="referred_by">

    <label>Referral Phone</label>
    <input type="tel" name="referral_phone">

    <h2 class="section-title">Treatment & Transition</h2>

    <label>Detox Completed?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="detox" value="yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="detox" value="no"> No</label>
    </div>

    <label>Inpatient Completed?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="inpatient" value="yes" id="inpatient_yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="inpatient" value="no" id="inpatient_no"> No</label>
    </div>

    <div id="inpatient_details" class="conditional-field">
      <label>Total Days</label>
      <input type="number" name="inpatient_days">

      <label>Treatment Facility</label>
      <input type="text" name="facility">

      <label>Facility Phone</label>
      <input type="tel" name="facility_phone">
    </div>

    <label>Attending IOP?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="iop" value="yes" id="iop_yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="iop" value="no" id="iop_no"> No</label>
    </div>

    <div id="iop_details" class="conditional-field">
      <label>If yes, where?</label>
      <input type="text" name="iop_where">

      <label>IOP Schedule</label>
      <textarea name="iop_schedule" rows="3" placeholder="e.g., Monday/Wednesday/Friday 6pm-9pm"></textarea>
    </div>

    <label>Do you have a job?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="job" value="yes" id="job_yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="job" value="no" id="job_no"> No</label>
    </div>

    <div id="job_details" class="conditional-field">
      <label>If yes, where?</label>
      <input type="text" name="job_where">

      <label>Work Schedule</label>
      <textarea name="job_schedule" rows="3" placeholder="e.g., Monday-Friday 9am-5pm"></textarea>
    </div>

    <label>Drug(s) of Choice</label>
    <input type="text" name="drugs">

    <label>Sobriety Date</label>
    <input type="date" name="sobriety_date">

    <label>Are you regularly attending recovery meetings (AA, NA, Smart Recovery, etc.)?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="attending_meetings" value="yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="attending_meetings" value="no"> No</label>
    </div>

    <label>Do you have a sponsor?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="sponsor" value="yes" id="sponsor_yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="sponsor" value="no" id="sponsor_no"> No</label>
    </div>

    <div id="sponsor_willingness" class="conditional-field">
      <label>If no, are you willing to get one?</label>
      <div class="inline">
        <label class="checkbox-group"><input type="radio" name="willing_sponsor" value="yes"> Yes</label>
        <label class="checkbox-group"><input type="radio" name="willing_sponsor" value="no"> No</label>
      </div>
    </div>

    <h2 class="section-title">Sober Living History</h2>

    <label>Is this your first time in sober living?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="first_sober_living" value="yes" id="first_sl_yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="first_sober_living" value="no" id="first_sl_no"> No</label>
    </div>

    <div id="previous_sl_details" class="conditional-field">
      <label>If no, how many sober living homes have you previously stayed in?</label>
      <input type="number" name="previous_sober_living_count" min="0" placeholder="Enter number">
    </div>

    <label>Have you ever been asked to leave a treatment facility or sober living house?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="asked_to_leave" value="yes" id="asked_leave_yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="asked_to_leave" value="no" id="asked_leave_no"> No</label>
    </div>

    <div id="asked_leave_explanation" class="conditional-field">
      <label>If yes, please explain the circumstances</label>
      <textarea name="asked_to_leave_explanation" rows="3" placeholder="Please provide details"></textarea>
    </div>

    <h2 class="section-title">Legal Status</h2>

    <label>Are you a 290 PC registrant?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="pc290" value="yes" id="pc290_yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="pc290" value="no" id="pc290_no"> No</label>
    </div>

    <label>Currently on probation or parole?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="probation" value="yes" id="probation_yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="probation" value="no" id="probation_no"> No</label>
    </div>

    <label>Any legal matters pending?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="legal_pending" value="yes" id="legal_pending_yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="legal_pending" value="no" id="legal_pending_no"> No</label>
    </div>

    <div id="legal_details_section" class="conditional-field">
      <label>Please provide details</label>
      <textarea name="legal_details" rows="3" placeholder="Explain any legal matters"></textarea>
    </div>

    <h2 class="section-title">Medical Information</h2>

    <label>Current Medications</label>
    <textarea name="medications" rows="3"></textarea>

    <label>Medical / Mental Health Conditions or Allergies</label>
    <textarea name="medical" rows="4"></textarea>

    <h2 class="section-title">House Responsibilities</h2>

    <label>Are you willing to do daily chores and help keep the house clean?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="chores" value="yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="chores" value="no"> No</label>
    </div>

    <label>Are you willing to follow a structured daily schedule which includes meetings, work or school, chores, accountability, random drug testing, and abiding by house rules and expectations?</label>
    <div class="inline">
      <label class="checkbox-group"><input type="radio" name="structured_schedule" value="yes"> Yes</label>
      <label class="checkbox-group"><input type="radio" name="structured_schedule" value="no"> No</label>
    </div>

    <h2 class="section-title">Signature & Certification</h2>

    <div style="background-color: #e8f4f8; padding: 20px; border-left: 4px solid #0066cc; margin-bottom: 25px; border-radius: 4px;">
      <p style="margin: 0; line-height: 1.6; font-size: 15px;">Thank you for your interest in Horizon House. We will carefully review your application to determine the best pathway for your success in lasting sobriety and will be in touch with you promptly. Your honesty and commitment to recovery are the foundation of our community.</p>
    </div>

    <label style="font-weight: 600; font-size: 1.1rem; margin-bottom: 15px; display: block;">Choose how you'd like to sign:</label>
    
    <div class="signature-options">
      <button type="button" class="sig-option-btn active" onclick="selectSignatureMethod('draw')" id="btn-draw">
        ‚úçÔ∏è Draw
      </button>
      <button type="button" class="sig-option-btn" onclick="selectSignatureMethod('type')" id="btn-type">
        ‚å®Ô∏è Type
      </button>
      <button type="button" class="sig-option-btn" onclick="selectSignatureMethod('upload')" id="btn-upload">
        üìÑ Upload
      </button>
    </div>

    <!-- Draw Signature -->
    <div id="draw-signature" class="signature-area active">
      <label>Draw your signature below:</label>
      <canvas id="signatureCanvas" class="signature-canvas"></canvas>
      <div class="sig-controls">
        <button type="button" onclick="clearSignature()">üóëÔ∏è Clear</button>
      </div>
    </div>

    <!-- Type Signature -->
    <div id="type-signature" class="signature-area">
      <label>Type your full name:</label>
      <input type="text" id="typedName" placeholder="John Doe" style="margin-bottom: 10px;">
      <div class="typed-signature" id="typedPreview"></div>
    </div>

    <!-- Upload Signature -->
    <div id="upload-signature" class="signature-area">
      <label>Upload signature image:</label>
      <input type="file" id="signatureUpload" accept="image/*" style="margin-bottom: 10px;">
      <div style="border: 2px solid #ccc; border-radius: 8px; padding: 20px; text-align: center; background: white; min-height: 120px;">
        <img id="uploadedPreview" style="max-width: 100%; max-height: 100px; display: none;">
        <p id="uploadPlaceholder" style="color: #999;">No file selected</p>
      </div>
    </div>

    <input type="hidden" name="signature" id="signatureData" required>
    <input type="hidden" name="signature_method" id="signatureMethod" value="draw">

    <label style="margin-top: 20px;">Date</label>
    <input type="date" name="signature_date" required id="signatureDate">

    <div style="background-color: #fff3cd; padding: 20px; border-left: 4px solid #ffc107; margin-top: 30px; border-radius: 4px;">
      <strong style="color: #856404; font-size: 16px;">‚úì Before You Submit</strong>
      <p style="margin: 10px 0 0 0; line-height: 1.6; color: #856404;">Your complete and truthful answers will help us determine the best pathway for your success. Please be sure your contact information is current so we can reach you promptly.</p>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button type="button" onclick="saveDraft()" style="background-color: #666; flex: 1;">Save Draft</button>
      <button type="submit" style="flex: 1;">Submit Application</button>
    </div>

  </form>
</main>

<footer>
  ¬© 2026 Horizon House Sober Living
</footer>

<div id="successModal">
  <div class="success-box">
    <h2>‚úì Thank You for Your Interest in Horizon House!</h2>
    <p>Your application has been submitted and will be reviewed by our admissions staff.</p>
    <p>We will be in contact with you shortly.</p>
    <div class="contact-info">
      <strong>Should you have any questions or need additional information, please call us:</strong><br>
      <strong style="font-size: 1.3rem; margin-top: 8px; display: block;">(760) 766-0300</strong>
    </div>
    <p style="margin-top: 1.5rem; font-size: 0.9rem; opacity: 0.9;">Redirecting to home page...</p>
  </div>
</div>

<script>
  const DRAFT_KEY = 'hhApplicationDraft';
  let currentReferenceNumber = null;

  // Reference Number & Draft Functions
  function generateReferenceNumber() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let ref = '';
    for (let i = 0; i < 6; i++) {
      ref += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return ref;
  }

  function startNewApplication() {
    currentReferenceNumber = generateReferenceNumber();
    
    // Clear the form completely
    const form = document.getElementById('applicationForm');
    form.reset();
    
    // Clear any conditional sections
    document.getElementById('vehicle_details').style.display = 'none';
    document.getElementById('job_details').style.display = 'none';
    document.getElementById('iop_details').style.display = 'none';
    
    // Clear signature canvas
    if (canvas) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    // Store reference number
    localStorage.setItem('currentApplicationRef', currentReferenceNumber);
    
    // Hide modal, show main content and reference display
    document.getElementById('referenceModal').style.display = 'none';
    document.getElementById('mainHeader').style.display = 'block';
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('referenceDisplay').style.display = 'block';
    document.getElementById('refNumberText').textContent = currentReferenceNumber;
    
    // Save empty draft immediately so it can be loaded later
    setTimeout(() => {
      saveDraft();
    }, 100);
    
    // Setup auto-save
    setupAutoSave();
  }

  function loadDraft() {
    const refInput = document.getElementById('referenceInput').value.trim().toUpperCase();
    
    if (!refInput) {
      alert('Please enter a reference number');
      return;
    }

    // Try loading from backend first
    fetch(`https://horizon-portal-backend-production-3532.up.railway.app/api/loadDraft/${refInput}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Draft not found');
        }
        return response.json();
      })
      .then(result => {
        if (result.success && result.formData) {
          currentReferenceNumber = refInput;
          
          // Hide modal, show main content and reference display
          document.getElementById('referenceModal').style.display = 'none';
          document.getElementById('mainHeader').style.display = 'block';
          document.getElementById('mainContent').style.display = 'block';
          document.getElementById('referenceDisplay').style.display = 'block';
          document.getElementById('refNumberText').textContent = currentReferenceNumber;
          
          // Populate form
          populateForm(result.formData);
          
          // Setup auto-save
          setupAutoSave();
          
          alert('Draft loaded successfully!');
        } else {
          throw new Error('Invalid draft data');
        }
      })
      .catch(error => {
        console.error('Error loading draft from backend:', error);
        
        // Fallback to localStorage
        const draftKey = `${DRAFT_KEY}_${refInput}`;
        const savedDraft = localStorage.getItem(draftKey);
        
        if (!savedDraft) {
          alert('No draft found with that reference number. Please check the number and try again.');
          return;
        }

        try {
          const draftData = JSON.parse(savedDraft);
          currentReferenceNumber = refInput;
          
          // Hide modal, show main content and reference display
          document.getElementById('referenceModal').style.display = 'none';
          document.getElementById('mainHeader').style.display = 'block';
          document.getElementById('mainContent').style.display = 'block';
          document.getElementById('referenceDisplay').style.display = 'block';
          document.getElementById('refNumberText').textContent = currentReferenceNumber;
          
          // Populate form
          populateForm(draftData);
          
          // Setup auto-save
          setupAutoSave();
          
          alert('Draft loaded successfully!');
        } catch (error) {
          console.error('Error loading draft:', error);
          alert('Error loading draft. Please try again.');
        }
      });
  }

  function saveDraft() {
    if (!currentReferenceNumber) return;
    
    try {
      const formData = collectFormData();
      
      console.log('Saving draft to backend:', currentReferenceNumber);
      
      // Show saving indicator
      const indicator = document.getElementById('saveIndicator');
      if (indicator) {
        indicator.textContent = 'üíæ Saving...';
        indicator.style.color = '#4299e1';
        indicator.style.display = 'block';
      }
      
      // Save to backend
      fetch('https://horizon-portal-backend-production-3532.up.railway.app/api/saveDraft', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          referenceNumber: currentReferenceNumber,
          formData: formData
        })
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          console.log('‚úì Draft saved to backend successfully');
          if (indicator) {
            indicator.textContent = '‚úì Draft saved at ' + new Date().toLocaleTimeString();
            indicator.style.color = '#48bb78';
            setTimeout(() => {
              indicator.textContent = '‚úì Draft saved';
            }, 3000);
          }
        }
      })
      .catch(error => {
        console.error('Error saving draft to backend:', error);
        // Fallback to localStorage if backend fails
        const draftKey = `${DRAFT_KEY}_${currentReferenceNumber}`;
        localStorage.setItem(draftKey, JSON.stringify(formData));
        console.log('‚úì Draft saved to localStorage as fallback');
        if (indicator) {
          indicator.textContent = '‚úì Draft saved (offline)';
          indicator.style.color = '#ed8936';
        }
      });
    } catch (error) {
      console.error('Error saving draft:', error);
    }
  }

  function collectFormData() {
    const form = document.getElementById('applicationForm');
    const formData = {};
    
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      if (input.type === 'radio') {
        if (input.checked) {
          formData[input.name] = input.value;
        }
      } else if (input.type === 'checkbox') {
        formData[input.name] = input.checked;
      } else {
        formData[input.name] = input.value;
      }
    });
    
    return formData;
  }

  function populateForm(data) {
    const form = document.getElementById('applicationForm');
    
    Object.keys(data).forEach(key => {
      // Try to find inputs with this name
      const inputs = form.querySelectorAll(`[name="${key}"]`);
      
      if (inputs.length === 0) return;
      
      inputs.forEach(input => {
        if (input.type === 'radio') {
          if (input.value === data[key]) {
            input.checked = true;
            input.dispatchEvent(new Event('change', { bubbles: true }));
          }
        } else if (input.type === 'checkbox') {
          input.checked = data[key];
          input.dispatchEvent(new Event('change', { bubbles: true }));
        } else {
          input.value = data[key] || '';
          input.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });
    });
  }

  let saveTimeout;
  function setupAutoSave() {
    const form = document.getElementById('applicationForm');
    
    form.addEventListener('input', (e) => {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveDraft();
      }, 500);
    });
    
    form.addEventListener('change', (e) => {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveDraft();
      }, 200);
    });
    
    // Also save on blur (when field loses focus)
    form.addEventListener('blur', (e) => {
      if (e.target.matches('input, select, textarea')) {
        clearTimeout(saveTimeout);
        saveDraft();
      }
    }, true);
  }

  // Check for existing reference on page load
  window.addEventListener('DOMContentLoaded', () => {
    // Always clear the currentApplicationRef when page loads to force fresh start
    localStorage.removeItem('currentApplicationRef');
    
    // Clear form completely on page load for HIPAA compliance
    const form = document.getElementById('applicationForm');
    if (form) {
      form.reset();
    }
    
    // Initialize signature canvas
    initSignatureCanvas();
  });

  // Signature functionality
  let canvas, ctx, isDrawing = false;

  function initSignatureCanvas() {
    canvas = document.getElementById('signatureCanvas');
    if (!canvas) return;
    
    ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = 200;
    
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    
    // Mouse events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile
    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);
    canvas.addEventListener('touchend', stopDrawing);
  }

  function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
  }

  function draw(e) {
    if (!isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    updateSignatureData();
  }

  function stopDrawing() {
    isDrawing = false;
  }

  function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
      clientX: touch.clientX,
      clientY: touch.clientY
    });
    canvas.dispatchEvent(mouseEvent);
  }

  function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById('signatureData').value = '';
  }

  function updateSignatureData() {
    if (canvas) {
      document.getElementById('signatureData').value = canvas.toDataURL();
    }
  }

  function selectSignatureMethod(method) {
    // Update buttons
    document.querySelectorAll('.sig-option-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${method}`).classList.add('active');
    
    // Update areas
    document.querySelectorAll('.signature-area').forEach(area => area.classList.remove('active'));
    document.getElementById(`${method}-signature`).classList.add('active');
    
    // Update hidden field
    document.getElementById('signatureMethod').value = method;
    
    // Initialize canvas if draw is selected
    if (method === 'draw' && !canvas) {
      setTimeout(initSignatureCanvas, 100);
    }
  }

  // Typed signature preview
  document.getElementById('typedName')?.addEventListener('input', function(e) {
    const preview = document.getElementById('typedPreview');
    preview.textContent = e.target.value || '';
    document.getElementById('signatureData').value = e.target.value;
  });

  // Upload signature
  document.getElementById('signatureUpload')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = document.getElementById('uploadedPreview');
        img.src = event.target.result;
        img.style.display = 'block';
        document.getElementById('uploadPlaceholder').style.display = 'none';
        document.getElementById('signatureData').value = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  });

  // Set today's date
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('signatureDate').value = today;
    
    // Initialize signature canvas
    initSignatureCanvas();
    
    // Populate DL expiration year dropdown (next 10 years)
    const dlYearSelect = document.getElementById('dl_exp_year');
    const currentYear = new Date().getFullYear();
    for (let i = 0; i <= 10; i++) {
      const year = currentYear + i;
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      dlYearSelect.appendChild(option);
    }
    
    // Show/hide year dropdown when clicking expiration date field
    const expirationInput = document.getElementById('dl_expiration');
    const yearDropdown = document.getElementById('dl_exp_year');
    
    expirationInput.addEventListener('click', function() {
      yearDropdown.style.display = yearDropdown.style.display === 'none' ? 'block' : 'none';
    });
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#dl_expiration') && !e.target.closest('#dl_exp_year')) {
        yearDropdown.style.display = 'none';
      }
    });
    
    // Calculate DL expiration date when year is selected or DOB changes
    function calculateDLExpiration() {
      const dobInput = document.querySelector('input[name="dob"]');
      const yearSelect = document.getElementById('dl_exp_year');
      
      if (dobInput.value && yearSelect.value) {
        const dob = new Date(dobInput.value + 'T00:00:00');
        const expYear = parseInt(yearSelect.value);
        
        // Set expiration to birthday in selected year
        const expDate = new Date(expYear, dob.getMonth(), dob.getDate());
        
        const month = String(expDate.getMonth() + 1).padStart(2, '0');
        const day = String(expDate.getDate()).padStart(2, '0');
        
        expirationInput.value = `${month}-${day}-${expYear}`;
        
        // Hide dropdown after selection
        yearDropdown.style.display = 'none';
      } else {
        expirationInput.value = '';
      }
    }
    
    document.querySelector('input[name="dob"]')?.addEventListener('change', calculateDLExpiration);
    document.getElementById('dl_exp_year')?.addEventListener('change', calculateDLExpiration);
    
    // Format all date inputs to show mm-dd-yyyy on change
    document.querySelectorAll('input[type="date"]').forEach(dateInput => {
      // Set initial format
      if (dateInput.value) {
        formatDateInput(dateInput);
      }
      
      // Format on change
      dateInput.addEventListener('change', function() {
        formatDateInput(this);
      });
      
      // Format on blur
      dateInput.addEventListener('blur', function() {
        formatDateInput(this);
      });
    });
  });
  
  function formatDateInput(input) {
    if (!input.value) return;
    
    const date = new Date(input.value + 'T00:00:00');
    if (isNaN(date.getTime())) return;
    
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const year = date.getFullYear();
    
    // Store the formatted value in a data attribute for display
    input.setAttribute('data-formatted', `${month}-${day}-${year}`);
    
    // Add display element if it doesn't exist
    if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('date-display')) {
      const display = document.createElement('div');
      display.className = 'date-display';
      display.style.marginTop = '5px';
      display.style.color = '#667eea';
      display.style.fontSize = '14px';
      display.style.fontWeight = '600';
      display.textContent = `Display: ${month}/${day}/${year}`;
      input.parentNode.insertBefore(display, input.nextSibling);
    } else {
      input.nextElementSibling.textContent = `Display: ${month}/${day}/${year}`;
    }
  }

  // Progressive disclosure event listeners
  document.addEventListener('DOMContentLoaded', function() {
    // Inpatient details
    document.getElementById('inpatient_yes')?.addEventListener('change', function() {
      document.getElementById('inpatient_details').style.display = 'block';
    });
    document.getElementById('inpatient_no')?.addEventListener('change', function() {
      document.getElementById('inpatient_details').style.display = 'none';
    });

    // IOP details
    document.getElementById('iop_yes')?.addEventListener('change', function() {
      document.getElementById('iop_details').style.display = 'block';
    });
    document.getElementById('iop_no')?.addEventListener('change', function() {
      document.getElementById('iop_details').style.display = 'none';
    });

    // Job details
    document.getElementById('job_yes')?.addEventListener('change', function() {
      document.getElementById('job_details').style.display = 'block';
    });
    document.getElementById('job_no')?.addEventListener('change', function() {
      document.getElementById('job_details').style.display = 'none';
    });

    // Vehicle details
    document.getElementById('vehicle_yes')?.addEventListener('change', function() {
      document.getElementById('vehicle_details').style.display = 'block';
    });
    document.getElementById('vehicle_no')?.addEventListener('change', function() {
      document.getElementById('vehicle_details').style.display = 'none';
    });

    // Sponsor willingness
    document.getElementById('sponsor_no')?.addEventListener('change', function() {
      document.getElementById('sponsor_willingness').style.display = 'block';
    });
    document.getElementById('sponsor_yes')?.addEventListener('change', function() {
      document.getElementById('sponsor_willingness').style.display = 'none';
    });

    // Previous sober living details
    document.getElementById('first_sl_no')?.addEventListener('change', function() {
      document.getElementById('previous_sl_details').style.display = 'block';
    });
    document.getElementById('first_sl_yes')?.addEventListener('change', function() {
      document.getElementById('previous_sl_details').style.display = 'none';
    });

    // Asked to leave explanation
    document.getElementById('asked_leave_yes')?.addEventListener('change', function() {
      document.getElementById('asked_leave_explanation').style.display = 'block';
    });
    document.getElementById('asked_leave_no')?.addEventListener('change', function() {
      document.getElementById('asked_leave_explanation').style.display = 'none';
    });

    // Legal details
    function checkLegalDetails() {
      const pc290 = document.getElementById('pc290_yes')?.checked;
      const probation = document.getElementById('probation_yes')?.checked;
      const pending = document.getElementById('legal_pending_yes')?.checked;
      
      if (pc290 || probation || pending) {
        document.getElementById('legal_details_section').style.display = 'block';
      } else {
        document.getElementById('legal_details_section').style.display = 'none';
      }
    }

    document.getElementById('pc290_yes')?.addEventListener('change', checkLegalDetails);
    document.getElementById('pc290_no')?.addEventListener('change', checkLegalDetails);
    document.getElementById('probation_yes')?.addEventListener('change', checkLegalDetails);
    document.getElementById('probation_no')?.addEventListener('change', checkLegalDetails);
    document.getElementById('legal_pending_yes')?.addEventListener('change', checkLegalDetails);
    document.getElementById('legal_pending_no')?.addEventListener('change', checkLegalDetails);
  });

  // Load draft on page load
  window.addEventListener('load', () => {
    const draft = localStorage.getItem(DRAFT_KEY);
    if (draft) {
      try {
        const data = JSON.parse(draft);
        Object.keys(data).forEach(key => {
          const field = document.querySelector(`[name="${key}"]`);
          if (field) {
            if (field.type === 'radio') {
              document.querySelector(`[name="${key}"][value="${data[key]}"]`).checked = true;
            } else if (field.type === 'checkbox') {
              field.checked = data[key] === 'on';
            } else {
              field.value = data[key];
            }
          }
        });
      } catch (e) {
        console.error('Error loading draft:', e);
      }
    }
  });

  // Auto-save draft every 30 seconds while filling out
  setInterval(() => {
    const form = document.getElementById('applicationForm');
    if (form && form.style.display !== 'none') {
      saveDraft();
    }
  }, 30000);

  document.getElementById('applicationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
      // Collect all form data
      const formData = new FormData(document.getElementById('applicationForm'));
      const data = {};
      formData.forEach((value, key) => {
        data[key] = value;
      });

      // Submit to backend
      const response = await fetch('https://horizon-portal-backend-production-3532.up.railway.app/api/submitApplication', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (response.ok) {
        // Clear draft after successful submission (backend and localStorage)
        if (currentReferenceNumber) {
          // Delete from backend
          fetch(`https://horizon-portal-backend-production-3532.up.railway.app/api/deleteDraft/${currentReferenceNumber}`, {
            method: 'DELETE'
          }).catch(error => console.error('Error deleting draft:', error));
          
          // Delete from localStorage
          const draftKey = `${DRAFT_KEY}_${currentReferenceNumber}`;
          localStorage.removeItem(draftKey);
          localStorage.removeItem('currentApplicationRef');
        }
        
        // Show success modal
        const modal = document.getElementById('successModal');
        modal.style.display = 'flex';
        
        // Reset form
        document.getElementById('applicationForm').reset();
        
        // Redirect to home page after 8 seconds
        setTimeout(() => {
          window.location.href = '/';
        }, 8000);
      } else {
        alert('Error: ' + (result.error || 'Failed to submit application'));
      }
    } catch (error) {
      console.error('Error submitting form:', error);
      alert('Unable to submit application. Please try again or contact support.');
    }
  });
</script>

</body>
</html>

