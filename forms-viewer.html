<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Intake Package Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; }
        .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 32px; }
        h1 { text-align: center; margin-bottom: 24px; }
        .member-info { background: #f0f4fa; padding: 16px; border-radius: 6px; margin-bottom: 24px; }
        .actions { display: flex; gap: 16px; justify-content: center; margin-bottom: 32px; }
        .actions button { padding: 10px 22px; border: none; border-radius: 4px; background: #1976d2; color: #fff; font-size: 1rem; cursor: pointer; transition: background 0.2s; }
        .actions button:hover { background: #125ea7; }
        .forms-list { margin-bottom: 32px; }
        .form-section { background: #f9f9f9; border-radius: 6px; margin-bottom: 24px; padding: 18px 20px; box-shadow: 0 1px 4px #0001; }
        .form-section h2 { margin-top: 0; font-size: 1.2rem; }
        .form-actions { margin-top: 10px; }
        .form-actions button { background: #43a047; margin-right: 8px; }
        .form-actions button:last-child { background: #d32f2f; }
        .form-actions button:hover { opacity: 0.9; }
        @media (max-width: 600px) { .container { padding: 10px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Full Intake Package</h1>
        <div class="member-info" id="memberInfo">
            <!-- Member info will be loaded here -->
        </div>
        <div class="actions">
            <button id="printAll"><i class="fa fa-print"></i> Print All</button>
            <button id="saveAll"><i class="fa fa-file-pdf"></i> Save All as PDF</button>
        </div>
        <div class="forms-list" id="formsList">
            <!-- All forms will be loaded here -->
        </div>
    </div>
    <script src="forms-viewer-print.js"></script>
    <script>

    // Utility: get query param from URL
    function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }

    // Try to get member ID from URL or sessionStorage
    function getMemberId() {
        let id = getQueryParam('id');
        if (id) return id;
        if (sessionStorage.intakeData) {
            try {
                const d = JSON.parse(sessionStorage.intakeData);
                if (d.id) return d.id;
            } catch {}
        }
        return null;
    }

    // Fetch member info from backend
    async function fetchMemberInfo(id) {
        try {
            const res = await fetch(`/horizon-portal/backend/api/getMember?id=${encodeURIComponent(id)}`);
            if (!res.ok) return null;
            const data = await res.json();
            return data;
        } catch {
            return null;
        }
    }

    // Render member info, fallback to manual entry if not found or if fields are missing
    async function loadMemberInfo() {
        let member = null;
        const id = getMemberId();
        if (id) {
            member = await fetchMemberInfo(id);
        }
        // Define required fields
        const requiredFields = [
            { key: 'FIRST_NAME', label: 'First Name' },
            { key: 'LAST_NAME', label: 'Last Name' },
            { key: 'STATU', label: 'Admit Date' },
            { key: 'FEE', label: 'Fee' },
            { key: 'DOB', label: 'DOB' },
            { key: 'PHONE', label: 'Phone' }
        ];
        let html = '';
        if (!member) {
            html += `<b>No member found.</b> Please enter all required fields below.<br>`;
            member = {};
        }
        requiredFields.forEach(f => {
            const val = member[f.key] || '';
            html += `<b>${f.label}:</b> `;
            if (val) {
                html += `${val} <br>`;
            } else {
                html += `<input type="text" id="input_${f.key}" placeholder="Enter ${f.label}" style="margin-bottom:6px;"> <br>`;
            }
        });
        document.getElementById('memberInfo').innerHTML = html;
    }

    function loadForms() {
        let html = '';
        testForms.forEach(form => {
            html += `<div class="form-section" id="form-${form.id}">
                <h2>${form.title}</h2>
                <div class="form-actions">
                    <button onclick="printForm('${form.id}')"><i class='fa fa-print'></i> Print</button>
                    <button onclick="saveForm('${form.id}')"><i class='fa fa-file-pdf'></i> Save as PDF</button>
                </div>
                <div class="form-content">${form.content}</div>
            </div>`;
        });
        document.getElementById('formsList').innerHTML = html;
    }

    // Replace print/save handlers to use real PDF/print logic
    function printForm(formId) { window.printAllForms(); }
    function saveForm(formId) { window.saveFormAsPDF(formId); }
    document.getElementById('printAll').onclick = () => window.printAllForms();
    document.getElementById('saveAll').onclick = () => window.saveAllFormsAsPDF();
    loadMemberInfo();
    loadForms();
    </script>
</body>
</html>
