<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - Horizon House</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-container h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-container p {
            color: #718096;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 15px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-login {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-login:hover {
            background: #5568d3;
        }

        .error-message {
            color: #e53e3e;
            margin-top: 10px;
            display: none;
        }

        .dashboard-container {
            display: none;
            max-width: 1200px;
            width: 100%;
        }

        .dashboard-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .dashboard-logo {
            max-width: 80px;
            max-height: 80px;
        }

        .dashboard-header h1 {
            color: #2d3748;
            font-size: 32px;
        }

        .btn-logout {
            padding: 10px 20px;
            background: #718096;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-logout:hover {
            background: #4a5568;
        }

        .btn-home {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }

        .btn-home:hover {
            background: #5568d3;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .dashboard-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .card-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .card-count {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .card-label {
            color: #718096;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            background: #e53e3e;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge.zero {
            background: #48bb78;
        }

        .card-email-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
        }

        .card-email-btn:hover {
            background: #38a169;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 40px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #2d3748;
            font-size: 24px;
            margin: 0;
        }

        .close {
            color: #718096;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #2d3748;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #eef2ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .btn-upload {
            width: 100%;
            padding: 12px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-upload:hover {
            background: #38a169;
        }

        .btn-upload:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .upload-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            display: none;
        }

        .upload-status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .upload-status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .section-header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .section-header h2 {
            color: #2d3748;
            font-size: 24px;
            margin: 0;
        }

        .section-header p {
            color: #718096;
            margin: 5px 0 0 0;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 18px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <h1>üîê Staff Login</h1>
        <p>Enter password to access staff dashboard</p>
        <form id="loginForm">
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required autofocus>
            </div>
            <button type="submit" class="btn-login">Login</button>
            <div class="error-message" id="errorMessage">Incorrect password. Please try again.</div>
        </form>
    </div>

    <!-- Dashboard -->
    <div class="dashboard-container" id="dashboardContainer">
        <div class="dashboard-header">
            <div class="dashboard-header-content">
                <img src="/hhlogo.png" alt="Horizon House Logo" class="dashboard-logo">
                <div>
                    <h1>üìä Staff Dashboard</h1>
                    <p style="color: #718096; margin-top: 5px;">Welcome to Horizon House Staff Portal</p>
                </div>
            </div>
            <div class="header-buttons">
                <a href="/" class="btn-home">üè† Home</a>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="loading" class="loading">Loading dashboard data...</div>

        <!-- Milestones Alert Section -->
        <div class="section-header" id="milestonesSection" style="display: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h2 style="color: white; margin: 0;">üéâ Birthdays & Milestones</h2>
            <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0;">Recent & Upcoming (7 days either way)</p>
        </div>

        <div id="milestonesGrid" class="dashboard-grid" style="display: none; margin-bottom: 30px;"></div>

        <!-- New Members Alert Section -->
        <div class="section-header" id="newMembersSection" style="display: none; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h2 style="color: white; margin: 0;">üëã New Members</h2>
            <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0;">Recently arrived (last 3 days)</p>
        </div>

        <div id="newMembersGrid" class="dashboard-grid" style="display: none; margin-bottom: 30px;"></div>

        <div class="section-header" id="pendingSection" style="display: none;">
            <h2>‚è≥ Pending Review</h2>
            <p>Items requiring staff attention</p>
        </div>

        <div class="dashboard-grid" id="dashboardGrid" style="display: none;">
            <a href="/horizon-portal/staff-reviews.html" class="dashboard-card">
                <div class="card-icon">üìã</div>
                <div class="card-title">Applications</div>
                <div class="card-count" id="appCount">-</div>
                <div class="card-label">Pending Review</div>
            </a>

            <a href="/contact-view.html" class="dashboard-card">
                <div class="card-icon">üì¨</div>
                <div class="card-title">Contact Forms</div>
                <div class="card-count" id="contactCount">-</div>
                <div class="card-label">Unread Messages</div>
            </a>

            <a href="/drug-screen-history.html" class="dashboard-card">
                <div class="card-icon">üß™</div>
                <div class="card-title">Drug Screens</div>
                <div class="card-count" id="drugScreenCount">-</div>
                <div class="card-label">Total Tests</div>
            </a>

            <a href="/horizon-portal/members/member-status.html" class="dashboard-card">
                <div class="card-icon">üö™</div>
                <div class="card-title">Sign In/Out</div>
                <div class="card-count" id="signInOutCount">-</div>
                <div class="card-label">Currently Out</div>
            </a>
        </div>

        <!-- Forms Section -->
        <div class="section-header" id="formsSection" style="display: none; margin-top: 30px;">
            <h2>üìù Forms & Intake</h2>
            <p>Create, manage, and review facility forms</p>
        </div>

        <div class="dashboard-grid" id="formsGrid" style="display: none;">
            <a href="/horizon-portal/staff-intake-portal.html" class="dashboard-card" style="grid-column: span 2; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-icon" style="font-size: 48px;">üìã</div>
                <div class="card-title" style="color: white; font-size: 28px;">Intake Forms Portal</div>
                <div class="card-count" id="totalIntakeForms" style="font-size: 32px; color: white;">-</div>
                <div class="card-label" style="color: rgba(255,255,255,0.9);">Manage All 6 Intake Forms</div>
            </a>

            <a href="/discharge-combined-fillable.html" class="dashboard-card">
                <div class="card-icon">üìÑ</div>
                <div class="card-title">Discharge Form</div>
                <div class="card-count" style="font-size: 24px; color: #718096;">Create</div>
                <div class="card-label">Member Discharge</div>
            </a>

            <a href="/property-storage-form.html" class="dashboard-card">
                <div class="card-icon">üì¶</div>
                <div class="card-title">Property Storage Log</div>
                <div class="card-count" style="font-size: 24px; color: #718096;">Create</div>
                <div class="card-label">Member Property</div>
            </a>

            <a href="/horizon-portal/forms-viewer.html" class="dashboard-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                <div class="card-icon" style="font-size: 48px; color: white;">üìÇ</div>
                <div class="card-title" style="color: white;">Submitted Forms</div>
                <div class="card-count" id="submittedFormsCount" style="font-size: 32px; color: white;">-</div>
                <div class="card-label" style="color: rgba(255,255,255,0.9);">Pending Filing</div>
            </a>

            <div class="dashboard-card" style="opacity: 0.6; cursor: not-allowed; background: #f0f0f0;">
                <div class="card-icon">üîß</div>
                <div class="card-title">Maintenance Request</div>
                <div class="card-count" style="font-size: 18px; color: #718096;">Coming Soon</div>
                <div class="card-label">Facility Repairs</div>
            </div>

            <a href="/drug-screen.html" class="dashboard-card">
                <div class="card-icon">üß™</div>
                <div class="card-title">Drug Screen Form</div>
                <div class="card-count" style="font-size: 24px; color: #718096;">New Test</div>
                <div class="card-label">Record Test Results</div>
            </a>

            <div class="dashboard-card" style="display: flex; flex-direction: column;">
                <a href="/application.html" style="text-decoration: none; color: inherit; flex: 1;">
                    <div class="card-icon">üìù</div>
                    <div class="card-title">Application Form</div>
                    <div class="card-count" style="font-size: 24px; color: #718096;">View Form</div>
                    <div class="card-label">Member Application</div>
                </a>
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <a href="#" onclick="emailApplicationLink(event)" class="card-email-btn" style="flex: 1;">‚úâÔ∏è Email Link</a>
                    <button onclick="copyApplicationLink(event)" class="card-email-btn" style="flex: 1; border: none;">üìã Copy Link</button>
                </div>
            </div>

            <a href="#" class="dashboard-card" style="opacity: 0.6; cursor: not-allowed;">
                <div class="card-icon">üìã</div>
                <div class="card-title">Contract Form</div>
                <div class="card-count" style="font-size: 24px; color: #718096;">Coming Soon</div>
                <div class="card-label">Behavioral Contract</div>
            </a>

            <div class="dashboard-card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; display: flex; flex-direction: column; justify-content: space-between;">
                <div>
                    <div class="card-icon" style="font-size: 48px;">üìä</div>
                    <div class="card-title" style="color: white;">Members Database</div>
                    <div class="card-count" style="font-size: 18px; color: white;">Edit & Manage</div>
                    <div class="card-label" style="color: rgba(255,255,255,0.9);">members.xlsx</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 15px;">
                    <button onclick="editMembersDatabase()" style="width: 100%; padding: 12px; background: white; color: #38a169; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">‚úèÔ∏è Edit Database</button>
                    <div style="display: flex; gap: 8px;">
                        <a href="https://horizon-portal-backend-production-3532.up.railway.app/api/downloadMembers" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 6px; text-align: center; font-weight: 600; font-size: 13px;" download>‚¨áÔ∏è Download</a>
                        <button onclick="openUploadModal()" style="flex: 1; padding: 8px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">‚¨ÜÔ∏è Upload</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì§ Upload members.xlsx</h2>
                <span class="close" onclick="closeUploadModal()">&times;</span>
            </div>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÇ</div>
                <p style="color: #4a5568; font-size: 18px; margin: 0;"><strong>Click to select file</strong> or drag and drop</p>
                <p style="color: #718096; font-size: 14px; margin-top: 8px;">Only .xlsx files accepted</p>
                <p id="selectedFileName" style="color: #667eea; font-weight: 600; margin-top: 12px; display: none;"></p>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx" onchange="handleFileSelect(event)">
            <button id="uploadButton" class="btn-upload" onclick="uploadFile()" disabled>Upload File</button>
            <div id="uploadStatus" class="upload-status"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://horizon-portal-backend-production-3532.up.railway.app';
        const STAFF_PASSWORD = 'horizon2026'; // Change this password
        const SESSION_KEY = 'horizonStaffAuth';

        // Check if already logged in
        if (sessionStorage.getItem(SESSION_KEY) === 'true') {
            showDashboard();
        }

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMessage');

            if (password === STAFF_PASSWORD) {
                sessionStorage.setItem(SESSION_KEY, 'true');
                showDashboard();
            } else {
                errorMsg.style.display = 'block';
                document.getElementById('password').value = '';
            }
        });

        function logout() {
            sessionStorage.removeItem(SESSION_KEY);
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('password').value = '';
        }

        async function showDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
            
            await loadDashboardData();
        }

        async function loadDashboardData() {
            try {
                // Fetch all data in parallel
                const [
                    applicationsRes, 
                    contactsRes, 
                    drugScreensRes, 
                    signInOutRes, 
                    agreementsRes,
                    licenseeRes,
                    roiRes,
                    emergencyRes,
                    liabilityRes,
                    propertyRes,
                    submittedFormsRes
                ] = await Promise.all([
                    fetch(`${API_BASE}/api/pendingApplications`),
                    fetch(`${API_BASE}/api/contactSubmissions`),
                    fetch(`${API_BASE}/api/drugScreens`),
                    fetch(`${API_BASE}/api/signInOut/current`),
                    fetch(`${API_BASE}/api/intake/agreements`),
                    fetch(`${API_BASE}/api/intake/licensee-agreement`),
                    fetch(`${API_BASE}/api/intake/release-of-information`),
                    fetch(`${API_BASE}/api/intake/emergency-contact`),
                    fetch(`${API_BASE}/api/intake/release-of-liability`),
                    fetch(`${API_BASE}/api/intake/personal-property-release`),
                    fetch(`${API_BASE}/api/forms`)
                ]);

                const applications = await applicationsRes.json();
                const contacts = await contactsRes.json();
                const drugScreens = await drugScreensRes.json();
                const signInOut = await signInOutRes.json();
                const agreements = await agreementsRes.json();
                const licensee = await licenseeRes.json();
                const roi = await roiRes.json();
                const emergency = await emergencyRes.json();
                const liability = await liabilityRes.json();
                const property = await propertyRes.json();
                const submittedForms = await submittedFormsRes.json();

                // Count pending applications (already filtered on backend)
                const pendingApps = applications.length;
                
                // Count unread contacts
                const unreadContacts = contacts.filter(c => c.status !== 'read').length;
                
                // Total drug screens
                const totalDrugScreens = drugScreens.length;

                // Members currently signed out
                const membersOut = signInOut.total || 0;

                // Total intake agreements
                const totalAgreements = agreements.length;
                
                // Total all intake forms
                const totalIntakeForms = agreements.length + licensee.length + roi.length + 
                                        emergency.length + liability.length + property.length;

                // Count submitted forms pending filing
                const pendingForms = submittedForms.filter(f => f.status === 'pending').length;

                // Load and check milestones
                await loadMilestones();
                
                // Load new members
                await loadNewMembers();

                // Update UI
                document.getElementById('appCount').textContent = pendingApps;
                document.getElementById('contactCount').textContent = unreadContacts;
                document.getElementById('drugScreenCount').textContent = totalDrugScreens;
                document.getElementById('signInOutCount').textContent = membersOut;
                if (document.getElementById('totalIntakeForms')) {
                    document.getElementById('totalIntakeForms').textContent = totalIntakeForms;
                }
                if (document.getElementById('submittedFormsCount')) {
                    document.getElementById('submittedFormsCount').textContent = pendingForms;
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('pendingSection').style.display = 'block';
                document.getElementById('dashboardGrid').style.display = 'grid';
                document.getElementById('formsSection').style.display = 'block';
                document.getElementById('formsGrid').style.display = 'grid';

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('loading').textContent = 'Error loading data. Please check backend connection.';
                document.getElementById('loading').style.color = '#e53e3e';
            }
        }

        // Milestone detection
        async function loadMilestones() {
            try {
                const response = await fetch(`${API_BASE}/api/members`);
                const allMembers = await response.json();
                
                // Filter active members (status 1, 2, 4, 5)
                const activeMembers = allMembers.filter(m => {
                    const status = m.STATUS || m.status || m.STATU;
                    return [1, 2, 4, 5].includes(status);
                });

                const milestones = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Reset to midnight for accurate day comparison
                const lookBackDays = 7; // Show recent events within past 7 days
                const lookAheadDays = 7; // Show upcoming events within next 7 days

                activeMembers.forEach(member => {
                    const firstName = member['FIRST\r\nNAME'] || member['FIRST\nNAME'] || member.FIRST_NAME || member.first_name || '';
                    const lastName = member['LAST\r\nNAME'] || member['LAST\nNAME'] || member.LAST_NAME || member.last_name || '';
                    const fullName = `${firstName} ${lastName}`.trim() || 'Unknown';
                    
                    // Helper to parse Excel date or regular date
                    function parseDate(val) {
                        if (!val) return null;
                        // Check if it's an Excel serial number (25569 = 1/1/1970 in Excel)
                        if (typeof val === 'number' || (!isNaN(val) && val > 10000)) {
                            const excelEpoch = new Date(1899, 11, 30); // Excel epoch
                            const date = new Date(excelEpoch.getTime() + val * 86400000);
                            return date;
                        }
                        // Try parsing as regular date
                        const parsed = new Date(val);
                        return isNaN(parsed.getTime()) ? null : parsed;
                    }
                    
                    // Check birthday
                    const dobStr = member.DOB || member.dob;
                    if (dobStr) {
                        const dob = parseDate(dobStr);
                        if (dob) {
                            // Create birthday for this year and last year
                            const birthdayThisYear = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
                            birthdayThisYear.setHours(0, 0, 0, 0);
                            
                            const birthdayLastYear = new Date(today.getFullYear() - 1, dob.getMonth(), dob.getDate());
                            birthdayLastYear.setHours(0, 0, 0, 0);
                            
                            // Check both this year and last year to capture recent past birthdays
                            [birthdayThisYear, birthdayLastYear].forEach(birthday => {
                                const daysDiff = Math.floor((birthday - today) / (1000 * 60 * 60 * 24));
                                
                                // Show if within past 7 days or next 7 days
                                if (daysDiff >= -lookBackDays && daysDiff <= lookAheadDays) {
                                    const age = birthday.getFullYear() - dob.getFullYear();
                                    milestones.push({
                                        type: 'birthday',
                                        name: fullName,
                                        detail: daysDiff >= 0 ? `Turning ${age}` : `Turned ${age}`,
                                        date: birthday,
                                        daysUntil: daysDiff,
                                        icon: 'üéÇ'
                                    });
                                }
                            });
                        }
                    }

                    // Check sobriety date
                    const sobrietyStr = member['SOBER\r\nDATE'] || member['SOBER\nDATE'] || member.SOBRIETY_DATE || member.sobriety_date || member.sobrietyDate;
                    if (sobrietyStr) {
                        const sobrietyDate = parseDate(sobrietyStr);
                        if (sobrietyDate) {
                            const daysSober = Math.floor((today - sobrietyDate) / (1000 * 60 * 60 * 24));
                            
                            // Check for upcoming milestones: 30, 60, 90, 120, 180, 270, 365, and yearly thereafter
                            const milestoneMarks = [30, 60, 90, 120, 180, 270, 365];
                            
                            // Add yearly milestones for years 2+
                            for (let year = 2; year <= 20; year++) {
                                milestoneMarks.push(year * 365);
                            }
                            
                            milestoneMarks.forEach(milestone => {
                                const daysUntilMilestone = milestone - daysSober;
                                // Show if within past 7 days or next 7 days
                                if (daysUntilMilestone >= -lookBackDays && daysUntilMilestone <= lookAheadDays) {
                                    const milestoneDate = new Date(sobrietyDate.getTime() + milestone * 24 * 60 * 60 * 1000);
                                    let label = `${milestone} days`;
                                    if (milestone >= 365) {
                                        const years = Math.floor(milestone / 365);
                                        label = `${years} year${years > 1 ? 's' : ''}`;
                                    }
                                    milestones.push({
                                        type: 'sobriety',
                                        name: fullName,
                                        detail: `${label} sober`,
                                        date: milestoneDate,
                                        daysUntil: daysUntilMilestone,
                                        icon: 'üéñÔ∏è'
                                    });
                                }
                            });
                        }
                    }
                });

                // Sort by days until milestone
                milestones.sort((a, b) => a.daysUntil - b.daysUntil);

                // Display milestones
                if (milestones.length > 0) {
                    const milestonesGrid = document.getElementById('milestonesGrid');
                    milestonesGrid.innerHTML = milestones.map(m => {
                        let dayText;
                        if (m.daysUntil === 0) {
                            dayText = 'TODAY!';
                        } else if (m.daysUntil === 1) {
                            dayText = 'Tomorrow';
                        } else if (m.daysUntil === -1) {
                            dayText = 'Yesterday';
                        } else if (m.daysUntil > 0) {
                            dayText = `In ${m.daysUntil} days`;
                        } else {
                            dayText = `${Math.abs(m.daysUntil)} days ago`;
                        }
                        
                        const dateText = m.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        const bgColor = m.type === 'birthday' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                        
                        return `
                            <div class="dashboard-card" style="background: ${bgColor}; color: white; border: none;">
                                <div class="card-icon" style="font-size: 48px;">${m.icon}</div>
                                <div class="card-title" style="color: white;">${m.name}</div>
                                <div class="card-count" style="color: white; font-size: 24px;">${dayText}</div>
                                <div class="card-label" style="color: rgba(255,255,255,0.9);">${m.detail}</div>
                                <div class="card-label" style="color: rgba(255,255,255,0.8); font-size: 13px; margin-top: 5px;">üìÖ ${dateText}</div>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('milestonesSection').style.display = 'block';
                    milestonesGrid.style.display = 'grid';
                } else {
                    document.getElementById('milestonesSection').style.display = 'none';
                    document.getElementById('milestonesGrid').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading milestones:', error);
                // Don't show milestones section if there's an error
                document.getElementById('milestonesSection').style.display = 'none';
                document.getElementById('milestonesGrid').style.display = 'none';
            }
        }

        // Load new members (arrived within last 3 days)
        async function loadNewMembers() {
            try {
                const response = await fetch(`${API_BASE}/api/members`);
                const allMembers = await response.json();
                
                // Filter active members (status 1, 2, 4, 5)
                const activeMembers = allMembers.filter(m => {
                    const status = m.STATUS || m.status || m.STATU;
                    return [1, 2, 4, 5].includes(status);
                });

                const newMembers = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const lookBackDays = 3; // Show members who arrived in last 3 days

                // Helper to parse Excel date or regular date
                function parseDate(val) {
                    if (!val) return null;
                    if (typeof val === 'number' || (!isNaN(val) && val > 10000)) {
                        const excelEpoch = new Date(1899, 11, 30);
                        const date = new Date(excelEpoch.getTime() + val * 86400000);
                        return date;
                    }
                    const parsed = new Date(val);
                    return isNaN(parsed.getTime()) ? null : parsed;
                }

                activeMembers.forEach(member => {
                    const firstName = member['FIRST\r\nNAME'] || member['FIRST\nNAME'] || member.FIRST_NAME || member.first_name || '';
                    const lastName = member['LAST\r\nNAME'] || member['LAST\nNAME'] || member.LAST_NAME || member.last_name || '';
                    const fullName = `${firstName} ${lastName}`.trim() || 'Unknown';
                    
                    // Check column H - try various possible column names for move-in/admission date
                    const moveInStr = member['MOVE IN DATE'] || member['MOVE-IN DATE'] || member['ADMISSION DATE'] || 
                                      member['MOVE IN'] || member.MOVE_IN_DATE || member.ADMISSION_DATE || 
                                      member['MOVE\r\nIN'] || member['MOVE\nIN'] || Object.values(member)[7]; // Column H is index 7
                    
                    if (moveInStr) {
                        const moveInDate = parseDate(moveInStr);
                        if (moveInDate) {
                            moveInDate.setHours(0, 0, 0, 0);
                            const daysSince = Math.floor((today - moveInDate) / (1000 * 60 * 60 * 24));
                            
                            // Show if moved in within last 3 days (0-3 days ago)
                            if (daysSince >= 0 && daysSince <= lookBackDays) {
                                newMembers.push({
                                    name: fullName,
                                    moveInDate: moveInDate,
                                    daysSince: daysSince
                                });
                            }
                        }
                    }
                });

                // Sort by most recent first
                newMembers.sort((a, b) => a.daysSince - b.daysSince);

                // Display new members
                if (newMembers.length > 0) {
                    const newMembersGrid = document.getElementById('newMembersGrid');
                    newMembersGrid.innerHTML = newMembers.map(m => {
                        let dayText;
                        if (m.daysSince === 0) {
                            dayText = 'Arrived TODAY!';
                        } else if (m.daysSince === 1) {
                            dayText = 'Arrived Yesterday';
                        } else {
                            dayText = `Arrived ${m.daysSince} days ago`;
                        }
                        
                        const dateText = m.moveInDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        
                        return `
                            <div class="dashboard-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: none;">
                                <div class="card-icon" style="font-size: 48px;">üëã</div>
                                <div class="card-title" style="color: white;">${m.name}</div>
                                <div class="card-count" style="color: white; font-size: 24px;">${dayText}</div>
                                <div class="card-label" style="color: rgba(255,255,255,0.9);">Welcome to Horizon House!</div>
                                <div class="card-label" style="color: rgba(255,255,255,0.8); font-size: 13px; margin-top: 5px;">üìÖ ${dateText}</div>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('newMembersSection').style.display = 'block';
                    newMembersGrid.style.display = 'grid';
                } else {
                    document.getElementById('newMembersSection').style.display = 'none';
                    document.getElementById('newMembersGrid').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading new members:', error);
                document.getElementById('newMembersSection').style.display = 'none';
                document.getElementById('newMembersGrid').style.display = 'none';
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                loadDashboardData();
            }
        }, 30000);

        // Email application link function
        function emailApplicationLink(event) {
            event.preventDefault();
            const applicationURL = window.location.origin + '/application.html';
            const subject = encodeURIComponent('Horizon House Sober Living - Application Form');
            const body = encodeURIComponent(
                'Hello,\n\n' +
                'Please complete the Horizon House Sober Living application form at the link below:\n\n' +
                applicationURL + '\n\n' +
                'If you have any questions, please contact us at mars@horizon-house.org or call us directly.\n\n' +
                'Best regards,\n' +
                'Horizon House Staff\n' +
                'mars@horizon-house.org'
            );
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Copy application link to clipboard
        async function copyApplicationLink(event) {
            event.preventDefault();
            const applicationURL = window.location.origin + '/application.html';
            
            try {
                await navigator.clipboard.writeText(applicationURL);
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.background = '#48bb78';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#48bb78';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy link. Please copy manually: ' + applicationURL);
            }
        }

        // Upload modal functions
        let selectedFile = null;

        function openUploadModal() {
            document.getElementById('uploadModal').style.display = 'block';
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            selectedFile = null;
            document.getElementById('selectedFileName').style.display = 'none';
            document.getElementById('uploadButton').disabled = true;
            document.getElementById('uploadStatus').style.display = 'none';
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.name.endsWith('.xlsx')) {
                selectedFile = file;
                document.getElementById('selectedFileName').textContent = '‚úÖ ' + file.name;
                document.getElementById('selectedFileName').style.display = 'block';
                document.getElementById('uploadButton').disabled = false;
            } else {
                alert('Please select a valid .xlsx file');
            }
        }

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.xlsx')) {
                selectedFile = file;
                document.getElementById('selectedFileName').textContent = '‚úÖ ' + file.name;
                document.getElementById('selectedFileName').style.display = 'block';
                document.getElementById('uploadButton').disabled = false;
            } else {
                alert('Please select a valid .xlsx file');
            }
        });

        async function uploadFile() {
            if (!selectedFile) return;

            const uploadButton = document.getElementById('uploadButton');
            const uploadStatus = document.getElementById('uploadStatus');

            uploadButton.disabled = true;
            uploadButton.textContent = 'Uploading...';
            uploadStatus.style.display = 'none';

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch(`${API_BASE}/api/uploadMembers`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    uploadStatus.className = 'upload-status success';
                    uploadStatus.textContent = '‚úÖ File uploaded successfully! Members database updated.';
                    uploadStatus.style.display = 'block';
                    setTimeout(() => {
                        closeUploadModal();
                        loadDashboardData(); // Refresh dashboard data
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.className = 'upload-status error';
                uploadStatus.textContent = '‚ùå Upload failed: ' + error.message;
                uploadStatus.style.display = 'block';
                uploadButton.disabled = false;
                uploadButton.textContent = 'Upload File';
            }
        }

        // Streamlined edit workflow
        async function editMembersDatabase() {
            const confirmed = confirm(
                'üìù Edit Members Database\n\n' +
                'This will:\n' +
                '1. Download the current members.xlsx file\n' +
                '2. Open it in Excel for editing\n' +
                '3. When done, click "Upload" to save your changes back\n\n' +
                'Continue?'
            );
            
            if (confirmed) {
                // Trigger download
                window.location.href = 'https://horizon-portal-backend-production-3532.up.railway.app/api/downloadMembers';
                
                // Show upload modal after a brief delay
                setTimeout(() => {
                    alert('‚úÖ File downloaded!\n\nüìù Open it in Excel, make your changes, save the file, then click "Upload" below.');
                    openUploadModal();
                }, 1500);
            }
        }
    </script>
</body>
</html>
